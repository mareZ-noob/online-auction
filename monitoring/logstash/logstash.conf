input {
  tcp {
    port => 5000
    codec => json_lines
  }
  
  # File input for application logs
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    codec => json
  }
}

filter {
  # Parse timestamp
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }
  
  # Add geoip if IP address is present
  if [clientIp] {
    geoip {
      source => "clientIp"
      target => "geoip"
    }
  }
  
  # Parse user agent
  if [userAgent] {
    useragent {
      source => "userAgent"
      target => "user_agent"
    }
  }
  
  # Add tags based on log level
  if [level] == "ERROR" or [level] == "FATAL" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  if [level] == "WARN" {
    mutate {
      add_tag => [ "warning" ]
    }
  }
  
  # Tag audit logs
  if [log_type] == "audit" {
    mutate {
      add_tag => [ "audit" ]
    }
  }
  
  # Extract exception information
  if [stack_trace] {
    mutate {
      add_tag => [ "exception" ]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "auction-logs-%{+YYYY.MM.dd}"
    user => "${ELASTIC_USER:elastic}"
    password => "${ELASTIC_PASSWORD:changeme}"
  }
  
  # Debug output (optional, can be removed in production)
  stdout {
    codec => rubydebug
  }
}
